-- NutriQ Analysis System Migration\n-- Research Track: Advanced AI Features & Pattern Recognition\n-- Created: January 25, 2025\n\n-- NutriQ Historical Assessments\nCREATE TABLE nutriq_assessments (\n  id VARCHAR PRIMARY KEY,\n  \n  -- Client Demographics (anonymized)\n  age_range VARCHAR,\n  gender VARCHAR,\n  location_region VARCHAR,\n  \n  -- Assessment Metadata\n  assessment_date DATE,\n  completion_status VARCHAR NOT NULL DEFAULT 'completed',\n  total_questions INTEGER,\n  time_spent_minutes INTEGER,\n  \n  -- Outcome Data\n  primary_conditions TEXT[] NOT NULL DEFAULT '{}',\n  secondary_conditions TEXT[] NOT NULL DEFAULT '{}',\n  severity_scores JSONB,\n  treatment_outcome VARCHAR,\n  follow_up_success BOOLEAN,\n  \n  -- Data Source & Quality\n  source_system VARCHAR NOT NULL DEFAULT 'nutriq',\n  data_quality_score FLOAT,\n  practitioner_validated BOOLEAN NOT NULL DEFAULT FALSE,\n  validation_notes TEXT,\n  \n  -- Research Metadata\n  anonymization_id VARCHAR UNIQUE,\n  research_cohort VARCHAR,\n  analysis_flags TEXT[] NOT NULL DEFAULT '{}',\n  \n  created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\n-- NutriQ Question Responses\nCREATE TABLE nutriq_responses (\n  id VARCHAR PRIMARY KEY,\n  assessment_id VARCHAR NOT NULL REFERENCES nutriq_assessments(id) ON DELETE CASCADE,\n  \n  -- Question Data\n  question_id INTEGER NOT NULL,\n  question_text TEXT NOT NULL,\n  question_category VARCHAR,\n  question_subcategory VARCHAR,\n  \n  -- Response Data\n  response_value INTEGER,\n  response_text VARCHAR,\n  response_confidence INTEGER,\n  \n  -- Analysis Metadata\n  diagnostic_weight FLOAT,\n  correlation_strength JSONB,\n  predictive_value FLOAT,\n  population_percentile INTEGER,\n  \n  -- Pattern Recognition\n  pattern_flags TEXT[] NOT NULL DEFAULT '{}',\n  cluster_assignment VARCHAR,\n  \n  answered_at TIMESTAMP,\n  created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n  \n  UNIQUE(assessment_id, question_id)\n);\n\n-- Functional Medicine Conditions\nCREATE TABLE functional_medicine_conditions (\n  id VARCHAR PRIMARY KEY,\n  name VARCHAR NOT NULL,\n  category VARCHAR,\n  \n  -- Clinical Definition\n  description TEXT,\n  clinical_markers TEXT[] NOT NULL DEFAULT '{}',\n  related_conditions TEXT[] NOT NULL DEFAULT '{}',\n  \n  -- Diagnostic Criteria\n  primary_questions INTEGER[] NOT NULL DEFAULT '{}',\n  secondary_questions INTEGER[] NOT NULL DEFAULT '{}',\n  exclusion_questions INTEGER[] NOT NULL DEFAULT '{}',\n  \n  -- Scoring Thresholds\n  threshold_unlikely FLOAT NOT NULL DEFAULT 30.0,\n  threshold_possible FLOAT NOT NULL DEFAULT 50.0,\n  threshold_probable FLOAT NOT NULL DEFAULT 75.0,\n  threshold_definite FLOAT NOT NULL DEFAULT 85.0,\n  \n  -- Mathematical Scoring\n  base_score FLOAT NOT NULL DEFAULT 0.0,\n  question_weights JSONB,\n  modifier_rules JSONB,\n  \n  -- Validation Metrics\n  diagnostic_accuracy FLOAT,\n  false_positive_rate FLOAT,\n  false_negative_rate FLOAT,\n  validation_sample_size INTEGER,\n  \n  -- Research Metadata\n  evidence_strength VARCHAR,\n  literature_references TEXT[] NOT NULL DEFAULT '{}',\n  practitioner_consensus FLOAT,\n  \n  created_at TIMESTAMP NOT NULL DEFAULT NOW(),\n  updated_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\n-- Pattern Analysis Results\nCREATE TABLE nutriq_pattern_analysis (\n  id VARCHAR PRIMARY KEY,\n  \n  -- Analysis Metadata\n  analysis_type VARCHAR NOT NULL,\n  model_version VARCHAR,\n  analysis_date TIMESTAMP NOT NULL DEFAULT NOW(),\n  sample_size INTEGER,\n  \n  -- Pattern Discovery\n  patterns_found JSONB,\n  correlation_matrix JSONB,\n  cluster_assignments JSONB,\n  predictive_models JSONB,\n  \n  -- Statistical Validation\n  confidence_interval JSONB,\n  p_values JSONB,\n  r_squared FLOAT,\n  cross_validation_score FLOAT,\n  \n  -- Diagnostic Insights\n  top_diagnostic_questions JSONB,\n  question_weights JSONB,\n  threshold_recommendations JSONB,\n  false_positive_predictors JSONB,\n  \n  -- Performance Metrics\n  processing_time_seconds INTEGER,\n  tokens_used INTEGER,\n  cost_estimate FLOAT,\n  accuracy_metrics JSONB,\n  \n  -- Research Status\n  peer_reviewed BOOLEAN NOT NULL DEFAULT FALSE,\n  clinical_validated BOOLEAN NOT NULL DEFAULT FALSE,\n  production_ready BOOLEAN NOT NULL DEFAULT FALSE,\n  validation_notes TEXT,\n  \n  created_at TIMESTAMP NOT NULL DEFAULT NOW()\n);\n\n-- Question Correlations\nCREATE TABLE question_correlations (\n  id VARCHAR PRIMARY KEY,\n  \n  -- Question Relationship\n  question_id_a INTEGER NOT NULL,\n  question_id_b INTEGER NOT NULL,\n  \n  -- Correlation Metrics\n  pearson_correlation FLOAT,\n  spearman_correlation FLOAT,\n  mutual_information FLOAT,\n  \n  -- Condition-Specific Correlations\n  condition_correlations JSONB,\n  \n  -- Sample Statistics\n  sample_size INTEGER,\n  confidence_interval_low FLOAT,\n  confidence_interval_high FLOAT,\n  p_value FLOAT,\n  \n  -- Analysis Context\n  analysis_cohort VARCHAR,\n  last_updated TIMESTAMP NOT NULL DEFAULT NOW(),\n  \n  UNIQUE(question_id_a, question_id_b, analysis_cohort)\n);\n\n-- Diagnostic Scores Cache\nCREATE TABLE diagnostic_scores_cache (\n  id VARCHAR PRIMARY KEY,\n  \n  -- Assessment References\n  assessment_id VARCHAR NOT NULL REFERENCES nutriq_assessments(id) ON DELETE CASCADE,\n  condition_id VARCHAR NOT NULL REFERENCES functional_medicine_conditions(id),\n  \n  -- Calculated Scores\n  raw_score FLOAT,\n  weighted_score FLOAT,\n  percentile_score INTEGER,\n  probability FLOAT,\n  \n  -- Diagnostic Classification\n  diagnostic_category VARCHAR,\n  confidence_level VARCHAR,\n  evidence_strength VARCHAR,\n  \n  -- Supporting Data\n  contributing_questions JSONB,\n  modifier_effects JSONB,\n  competing_conditions JSONB,\n  \n  -- Performance Metadata\n  calculation_version VARCHAR,\n  calculated_at TIMESTAMP NOT NULL DEFAULT NOW(),\n  expires_at TIMESTAMP,\n  \n  UNIQUE(assessment_id, condition_id)\n);\n\n-- Create Indexes for Performance\nCREATE INDEX idx_nutriq_demographics ON nutriq_assessments(age_range, gender);\nCREATE INDEX idx_nutriq_outcomes ON nutriq_assessments USING GIN(primary_conditions);\nCREATE INDEX idx_nutriq_quality ON nutriq_assessments(data_quality_score DESC);\nCREATE INDEX idx_nutriq_analysis ON nutriq_assessments USING GIN(analysis_flags);\n\nCREATE INDEX idx_nutriq_question ON nutriq_responses(question_id, response_value);\nCREATE INDEX idx_nutriq_correlation ON nutriq_responses(diagnostic_weight DESC);\nCREATE INDEX idx_nutriq_patterns ON nutriq_responses USING GIN(pattern_flags);\nCREATE INDEX idx_nutriq_assessment_responses ON nutriq_responses(assessment_id);\n\nCREATE INDEX idx_pattern_type ON nutriq_pattern_analysis(analysis_type);\nCREATE INDEX idx_pattern_quality ON nutriq_pattern_analysis(r_squared DESC);\nCREATE INDEX idx_pattern_date ON nutriq_pattern_analysis(analysis_date DESC);\n\nCREATE INDEX idx_correlation_strength ON question_correlations(pearson_correlation DESC);\nCREATE INDEX idx_correlation_questions ON question_correlations(question_id_a, question_id_b);\n\nCREATE INDEX idx_scores_condition ON diagnostic_scores_cache(condition_id, probability DESC);\nCREATE INDEX idx_scores_assessment ON diagnostic_scores_cache(assessment_id);\nCREATE INDEX idx_scores_performance ON diagnostic_scores_cache(diagnostic_category, confidence_level);\n\n-- Seed Functional Medicine Conditions\nINSERT INTO functional_medicine_conditions (id, name, category) VALUES\n('digestive_dysfunction', 'Digestive Dysfunction', 'gastrointestinal'),\n('adrenal_fatigue', 'Adrenal Fatigue/HPA Axis Dysfunction', 'endocrine'),\n('thyroid_dysfunction', 'Thyroid Dysfunction', 'endocrine'),\n('blood_sugar_dysregulation', 'Blood Sugar Dysregulation', 'metabolic'),\n('chronic_inflammation', 'Chronic Inflammation', 'immune'),\n('detoxification_impairment', 'Detoxification Impairment', 'hepatic'),\n('hormonal_imbalances', 'Hormonal Imbalances', 'endocrine'),\n('cardiovascular_dysfunction', 'Cardiovascular Dysfunction', 'cardiovascular'),\n('immune_system_dysfunction', 'Immune System Dysfunction', 'immune'),\n('neurotransmitter_imbalances', 'Neurotransmitter Imbalances', 'neurological'),\n('mitochondrial_dysfunction', 'Mitochondrial Dysfunction', 'cellular'),\n('food_sensitivities', 'Food Sensitivities/Allergies', 'immune'),\n('heavy_metal_toxicity', 'Heavy Metal Toxicity', 'toxicological'),\n('gut_microbiome_imbalances', 'Gut Microbiome Imbalances', 'gastrointestinal'),\n('chronic_stress_response', 'Chronic Stress Response', 'neurological');\n\n-- Create trigger for updated_at timestamps\nCREATE OR REPLACE FUNCTION update_updated_at_column()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ language 'plpgsql';\n\nCREATE TRIGGER update_nutriq_assessments_updated_at BEFORE UPDATE ON nutriq_assessments FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();\nCREATE TRIGGER update_functional_medicine_conditions_updated_at BEFORE UPDATE ON functional_medicine_conditions FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();